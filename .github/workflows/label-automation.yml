# Label Automation Workflow
# Implements label-driven state management for issues


name: "Label Automation"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number }}
  cancel-in-progress: false

on:
  issues:
    types:
      - labeled
      - unlabeled
      - closed
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  label-automation:
    runs-on: ubuntu-latest
    steps:
      - name: Close issue if labeled 'state:done'
        if: github.event.action == 'labeled' && github.event.label.name == 'state:done'
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            })

      - name: Add 'state:done' label if issue closed and missing
        if: github.event.action == 'closed'
        uses: actions/github-script@v6
        with:
          script: |
            const hasDone = context.payload.issue.labels.some(l => l.name === 'state:done');
            if (!hasDone) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['state:done']
              });
            }

      - name: Comment if labeled 'gate:needs-approval'
        if: github.event.action == 'labeled' && github.event.label.name == 'gate:needs-approval'
        uses: actions/github-script@v6
        with:
          script: |
            const comments = await github.paginate(
              github.rest.issues.listComments,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                per_page: 100
              }
            );
            const alreadyCommented = comments.some(c => c.body === 'Added to Decision Desk.');
            if (!alreadyCommented) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: 'Added to Decision Desk.'
              });
            }
